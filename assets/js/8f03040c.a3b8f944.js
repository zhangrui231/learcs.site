"use strict";(self.webpackChunklearncs_set=self.webpackChunklearncs_set||[]).push([[8083],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),u=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=u(e.components);return i.createElement(s.Provider,{value:t},e.children)},h="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=u(n),m=a,d=h["".concat(s,".").concat(m)]||h[m]||p[m]||o;return n?i.createElement(d,r(r({ref:t},c),{},{components:n})):i.createElement(d,r({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[h]="string"==typeof e?e:a,r[1]=l;for(var u=2;u<o;u++)r[u]=n[u];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7535:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var i=n(87462),a=(n(67294),n(3905));const o={},r="CS 61C",l={unversionedId:"curriculum-resource/cs61c/labs/lab03",id:"curriculum-resource/cs61c/labs/lab03",title:"CS 61C",description:"Deadline: Friday, September 18th",source:"@site/docs/curriculum-resource/cs61c/labs/lab03.md",sourceDirName:"curriculum-resource/cs61c/labs",slug:"/curriculum-resource/cs61c/labs/lab03",permalink:"/docs/curriculum-resource/cs61c/labs/lab03",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"CS 61C",permalink:"/docs/curriculum-resource/cs61c/labs/lab02"},next:{title:"CS 61C",permalink:"/docs/curriculum-resource/cs61c/labs/lab04"}},s={},u=[{value:"Before you begin",id:"before-you-begin",level:2},{value:"Goals",id:"goals",level:2},{value:"Getting the files",id:"getting-the-files",level:2},{value:"Intro to Assembly with RISC-V Simulator",id:"intro-to-assembly-with-risc-v-simulator",level:2},{value:"Assembly/Venus Basics",id:"assemblyvenus-basics",level:3},{value:"Exercise 0: Connecting your files to Venus",id:"exercise-0-connecting-your-files-to-venus",level:2},{value:"Exercise 1: Familiarizing yourself with Venus",id:"exercise-1-familiarizing-yourself-with-venus",level:2},{value:"Action Item",id:"action-item",level:3},{value:"Exercise 2: Translating from C to RISC-V",id:"exercise-2-translating-from-c-to-risc-v",level:2},{value:"Action Item",id:"action-item-1",level:3},{value:"Exercise 3: Factorial",id:"exercise-3-factorial",level:2},{value:"Testing",id:"testing",level:3},{value:"Exercise 4: Calling Convention Checker",id:"exercise-4-calling-convention-checker",level:2},{value:"Action Item",id:"action-item-2",level:3},{value:"Testing",id:"testing-1",level:3},{value:"Exercise 5: RISC-V function calling with <code>map</code>",id:"exercise-5-risc-v-function-calling-with-map",level:2},{value:"Action Item",id:"action-item-3",level:3},{value:"Testing",id:"testing-2",level:3},{value:"Transitioning to More Complex RISC-V Programs",id:"transitioning-to-more-complex-risc-v-programs",level:2},{value:"Checkoff",id:"checkoff",level:2}],c={toc:u},h="wrapper";function p(e){let{components:t,...o}=e;return(0,a.kt)(h,(0,i.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"cs-61c"},"CS 61C"),(0,a.kt)("p",null,"Deadline: Friday, September 18th"),(0,a.kt)("h2",{id:"before-you-begin"},"Before you begin"),(0,a.kt)("p",null,"This lab is somewhat longer than the previous labs (and longer than most future labs as well). This is in order to give everyone a chance to get comfortable with writing RISC-V and using the Venus simulator before the release of project 2, which will require you to write a fair amount of assembly."),(0,a.kt)("p",null,"To this end, we recommend that you watch this week\u2019s lectures and get started on this assignment as early as possible. Good luck! If you have any questions or run into any issues, then please feel free to ask in office hours or on Piazza."),(0,a.kt)("h2",{id:"goals"},"Goals"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Practice running and debugging RISC-V assembly code."),(0,a.kt)("li",{parentName:"ul"},"Write RISC-V functions with the correct function calling procedure."),(0,a.kt)("li",{parentName:"ul"},"Get an idea of how to translate C code to RISC-V."),(0,a.kt)("li",{parentName:"ul"},"Get familiar with using the Venus simulator")),(0,a.kt)("h2",{id:"getting-the-files"},"Getting the files"),(0,a.kt)("p",null,"To get the starter files for this lab, run the following command in your ",(0,a.kt)("inlineCode",{parentName:"p"},"labs")," directory."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ git pull starter master\n\n")),(0,a.kt)("p",null,"If you get an error like the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"fatal: 'starter' does not appear to be a git repository\nfatal: Could not read from remote repository.\n\n")),(0,a.kt)("p",null,"make sure to set the starter remote as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git remote add starter https://github.com/61c-teach/fa20-lab-starter.git\n\n")),(0,a.kt)("p",null,"and run the original command again."),(0,a.kt)("h2",{id:"intro-to-assembly-with-risc-v-simulator"},"Intro to Assembly with RISC-V Simulator"),(0,a.kt)("p",null,"In this course, we have so far dealt mostly with C programs (with the ",(0,a.kt)("inlineCode",{parentName:"p"},".c")," file extension), used the ",(0,a.kt)("inlineCode",{parentName:"p"},"gcc")," program to compile them to machine code, and then executed them directly on your computer or hive machine. Now, we\u2019re shifting our focus to the RISC-V assembly language, which is a lower-level language much closer to machine code. We can\u2019t execute RISC-V code directly because your computer and the hives are built to run machine code from other assembly languages - most likely x86 or ARM."),(0,a.kt)("p",null,"In this lab, we will deal with several RISC-V assembly program files, each of which have a ",(0,a.kt)("inlineCode",{parentName:"p"},".s")," file extension. To run these, we will need to use ",(0,a.kt)("strong",{parentName:"p"},"Venus"),", a RISC-V simulator that you can find ",(0,a.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20230126061759/https://venus.cs61c.org/"},"here"),". There is also a ",(0,a.kt)("inlineCode",{parentName:"p"},".jar")," version of Venus that we have provided in the ",(0,a.kt)("inlineCode",{parentName:"p"},"tools")," folder under your base lab repository."),(0,a.kt)("h3",{id:"assemblyvenus-basics"},"Assembly/Venus Basics"),(0,a.kt)("p",null,"To get started with Venus, please take a look at \u201cThe Editor Tab\u201d and \u201cThe Simulator Tab\u201d in the ",(0,a.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20230126061759/https://inst.eecs.berkeley.edu/~cs61c/sp21/resources/venus-reference"},"Venus reference"),". We recommend that you read this whole page at some point, but these sections should be enough to get started."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"For the following exercises, please make sure your completed code is saved on a file on your local machine. Otherwise, we will have no proof that you completed the lab exercises.")),(0,a.kt)("h2",{id:"exercise-0-connecting-your-files-to-venus"},"Exercise 0: Connecting your files to Venus"),(0,a.kt)("p",null,"In previous iterations of the course, the Venus web editor allows you to write assembly code from scratch or to manually upload and download files, but thanks to a recent update, you can now \u201cmount\u201d a folder from your local device onto Venus\u2019s web frontend! This means that any changes you make in Venus\u2019s editor will be reflected in your local files, and vice versa."),(0,a.kt)("p",null,"This exercise will walk you through the process of connecting your file system to Venus, which should save you a lot of trouble copy/pasting files between your local drive and the Venus editor."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"If for some reason this feature ends up not working for you")," (it\u2019s relatively new, and there\u2019s a chance there might still be bugs), then for the rest of this assignment, wherever it says to open a file in Venus, you should copy/paste the contents into the Venus web editor, and manually copy/paste those changes back to your local machine."),(0,a.kt)("p",null,"Here\u2019s what you need to do:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"In the labs folder on your local machine, run ",(0,a.kt)("inlineCode",{parentName:"li"},"java -jar tools/venus.jar . -dm"),". This will expose your lab directory to Venus on a network port (6161 by default).",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"You should see the message ",(0,a.kt)("inlineCode",{parentName:"li"},"To connect, enter `mount http://localhost:6161 vmfs` on Venus."),", as well as a a big \u201cJavalin\u201d logo."),(0,a.kt)("li",{parentName:"ul"},"If you see a message along the lines of \u201cport unable to be bound\u201d, then you can specify the port number explicitly by appending ",(0,a.kt)("inlineCode",{parentName:"li"},"--port <port number>")," to the command (for example, ",(0,a.kt)("inlineCode",{parentName:"li"},"java -jar tools/venus.jar . -dm --port 6162")," will expose the file system on port 6162)"))),(0,a.kt)("li",{parentName:"ul"},"Open ",(0,a.kt)("a",{parentName:"li",href:"https://venus.cs61c.org"},"https://venus.cs61c.org")," in your web browser. In the Venus terminal, run ",(0,a.kt)("inlineCode",{parentName:"li"},"mount local vmfs")," (if you chose a different port, replace \u201clocal\u201d with the full URL, such as ",(0,a.kt)("inlineCode",{parentName:"li"},"http://localhost:6162"),"). This connects Venus to your file system."),(0,a.kt)("li",{parentName:"ul"},"Go to the \u201cFiles\u201d tab. You should now be able to see your labs directory under the ",(0,a.kt)("inlineCode",{parentName:"li"},"vmfs")," folder."),(0,a.kt)("li",{parentName:"ul"},"Navigate to ",(0,a.kt)("inlineCode",{parentName:"li"},"lab03"),", and make sure it works by hitting the ",(0,a.kt)("inlineCode",{parentName:"li"},"Edit")," button next to ",(0,a.kt)("inlineCode",{parentName:"li"},"ex1.s"),". This should open in the ",(0,a.kt)("inlineCode",{parentName:"li"},"Editor")," tab.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"If you make any changes to the file in the ",(0,a.kt)("inlineCode",{parentName:"li"},"Editor")," tab, hitting command-s on a Mac and ctrl-s on Windows/Linux will update your local copy of the file. To check if the save was successful, open the file on your local machine to see if it matches what you have in the web editor (unfortunately no feedback message has been implemented yet)."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Note:")," If you make any changes to a file in your local machine, if you had the same file open in the Venus editor, you\u2019ll need to reopen it from the \u201cFiles\u201d menu to get the new changes."))),(0,a.kt)("li",{parentName:"ul"},"To make it so that the file system will attempt to remount automatically whenever you close and reopen Venus, enable \u201cSave on Close\u201d in the Settings pane (again in the Venus tab). This will make the Venus web client attempt to locate the file system exposed by running the Venus jar, and will pop up an error saying that it couldn\u2019t connect to the server if it doesn\u2019t see it running. If this happens, just follow the above steps to manually remount the file system.")),(0,a.kt)("p",null,"Once you\u2019ve got ",(0,a.kt)("inlineCode",{parentName:"p"},"ex1.s")," open, you\u2019re ready to move on to Exercise 1!"),(0,a.kt)("h2",{id:"exercise-1-familiarizing-yourself-with-venus"},"Exercise 1: Familiarizing yourself with Venus"),(0,a.kt)("p",null,"Getting started:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Open ",(0,a.kt)("inlineCode",{parentName:"li"},"ex1.s")," into the Venus editor. If you were unable to mount the filesystem in Exercise 0, then you can copy/paste ",(0,a.kt)("inlineCode",{parentName:"li"},"ex1.s")," from your local machine into the Venus editor directly."),(0,a.kt)("li",{parentName:"ol"},"Click the \u201cSimulator\u201d tab and click the \u201cAssemble & Simulate from Editor\u201d button. This will prepare the code you wrote for execution. If you click back to the \u201cEditor\u201d tab, your simulation will be reset."),(0,a.kt)("li",{parentName:"ol"},"In the simulator, to execute the next instruction, click the \u201cstep\u201d button."),(0,a.kt)("li",{parentName:"ol"},"To undo an instruction, click the \u201cprev\u201d button. Note that undo may or may not undo operations performed by ",(0,a.kt)("inlineCode",{parentName:"li"},"ecall"),", such as exiting the program or printing to console."),(0,a.kt)("li",{parentName:"ol"},"To run the program to completion, click the \u201crun\u201d button."),(0,a.kt)("li",{parentName:"ol"},"To reset the program from the start, click the \u201creset\u201d button."),(0,a.kt)("li",{parentName:"ol"},"The contents of all 32 registers are on the right-hand side, and the console output is at the bottom."),(0,a.kt)("li",{parentName:"ol"},"To view the contents of memory, click the \u201cMemory\u201d tab on the right. You can navigate to different portions of your memory using the dropdown menu at the bottom.")),(0,a.kt)("h3",{id:"action-item"},"Action Item"),(0,a.kt)("p",null,"Open ",(0,a.kt)("inlineCode",{parentName:"p"},"ex1.s")," in Venus and record your answers to the following questions. Some of the questions will require you to run the RISC-V code using Venus\u2019s simulator tab."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"What do the ",(0,a.kt)("inlineCode",{parentName:"li"},".data"),", ",(0,a.kt)("inlineCode",{parentName:"li"},".word"),", ",(0,a.kt)("inlineCode",{parentName:"li"},".text")," directives mean (i.e. what do you use them for)? ",(0,a.kt)("strong",{parentName:"li"},"Hint"),": think about the 4 sections of memory."),(0,a.kt)("li",{parentName:"ol"},"Run the program to completion. What number did the program output? What does this number represent?"),(0,a.kt)("li",{parentName:"ol"},"At what address is ",(0,a.kt)("inlineCode",{parentName:"li"},"n")," stored in memory? ",(0,a.kt)("strong",{parentName:"li"},"Hint"),": Look at the contents of the registers."),(0,a.kt)("li",{parentName:"ol"},"Without actually editing the code (i.e. without going into the \u201cEditor\u201d tab), have the program calculate the 13th fib number (0-indexed) by ",(0,a.kt)("em",{parentName:"li"},"manually")," modifying the value of a register. You may find it helpful to first step through the code. If you prefer to look at decimal values, change the \u201cDisplay Settings\u201d option at the bottom.")),(0,a.kt)("h2",{id:"exercise-2-translating-from-c-to-risc-v"},"Exercise 2: Translating from C to RISC-V"),(0,a.kt)("p",null,"Open the files ",(0,a.kt)("inlineCode",{parentName:"p"},"ex2.c")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"ex2.s"),". The assembly code provided (.s file) is a translation of the given C program into RISC-V."),(0,a.kt)("p",null,"In addition to opening a file in the \u201cEditor\u201d tab and then running in the \u201cSimulator\u201d tab as described above, you can also run ",(0,a.kt)("inlineCode",{parentName:"p"},"ex2.s")," directly within the Venus terminal by ",(0,a.kt)("inlineCode",{parentName:"p"},"cd"),"ing into the appropriate folder, then running ",(0,a.kt)("inlineCode",{parentName:"p"},"run ex2.s")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"./ex2.s"),". Typing ",(0,a.kt)("inlineCode",{parentName:"p"},"vdb ex2.s")," will also assemble the file and take you to the \u201cSimulator\u201d tab directly."),(0,a.kt)("h3",{id:"action-item-1"},"Action Item"),(0,a.kt)("p",null,"Find/explain the following components of this assembly file."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The register representing the variable ",(0,a.kt)("inlineCode",{parentName:"li"},"k"),"."),(0,a.kt)("li",{parentName:"ul"},"The register representing the variable ",(0,a.kt)("inlineCode",{parentName:"li"},"sum"),"."),(0,a.kt)("li",{parentName:"ul"},"The registers acting as pointers to the ",(0,a.kt)("inlineCode",{parentName:"li"},"source")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"dest")," arrays."),(0,a.kt)("li",{parentName:"ul"},"The assembly code for the loop found in the C code."),(0,a.kt)("li",{parentName:"ul"},"How the pointers are manipulated in the assembly code.")),(0,a.kt)("h2",{id:"exercise-3-factorial"},"Exercise 3: Factorial"),(0,a.kt)("p",null,"In this exercise, you will be implementing the ",(0,a.kt)("inlineCode",{parentName:"p"},"factorial")," function in RISC-V. This function takes in a single integer parameter ",(0,a.kt)("inlineCode",{parentName:"p"},"n")," and returns ",(0,a.kt)("inlineCode",{parentName:"p"},"n!"),". A stub of this function can be found in the file ",(0,a.kt)("inlineCode",{parentName:"p"},"factorial.s"),"."),(0,a.kt)("p",null,"You will only need to add instructions under the ",(0,a.kt)("inlineCode",{parentName:"p"},"factorial")," label, and the argument that is passed into the function is configured to be located at the label ",(0,a.kt)("inlineCode",{parentName:"p"},"n"),". You may solve this problem using either recursion or iteration. You may also assume that the ",(0,a.kt)("inlineCode",{parentName:"p"},"factorial")," function will only be called on positive values with results that won\u2019t overflow a 32-bit two\u2019s complement integer."),(0,a.kt)("h3",{id:"testing"},"Testing"),(0,a.kt)("p",null,"As a sanity check, you should make sure your function properly returns that ",(0,a.kt)("inlineCode",{parentName:"p"},"3! = 6"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"7! = 5040")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"8! = 40320"),"."),(0,a.kt)("p",null,"You have the option to test this using the online version of Venus, but we\u2019ve provided a ",(0,a.kt)("inlineCode",{parentName:"p"},".jar")," for you to test locally! We\u2019ll be using the ",(0,a.kt)("inlineCode",{parentName:"p"},".jar")," in the autograder so make sure to update your ",(0,a.kt)("inlineCode",{parentName:"p"},"factorial.s")," file and run the following command before you submit to verify that the output is correct. Note that you will need to have java installed to run this command."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ java -jar tools/venus.jar lab03/factorial.s\n\n")),(0,a.kt)("h2",{id:"exercise-4-calling-convention-checker"},"Exercise 4: Calling Convention Checker"),(0,a.kt)("p",null,"In this exercise, we\u2019ll be looking at the code in ",(0,a.kt)("inlineCode",{parentName:"p"},"cc_test.s"),". We\u2019ll be using a feature that\u2019s only available on the command line version of Venus, so if you\u2019re still using the Venus web editor, make sure you hit cmd-s or ctrl-s to make sure your changes are reflected in your local files. Likewise, if you modify your local files and want to use the Venus web simulator, make sure to reopen your file through the simulator to make sure the changes are reflected."),(0,a.kt)("p",null,"Throughout this course, we will be running automated checks to make sure your assembly complies with RISC-V calling conventions, as described in lecture and discussion. Here\u2019s a quick recap: all functions that overwrite registers that are preserved by convention must have a prologue, which saves those register values to the stack at the start of the function, and an epilogue, which restores those values for the function\u2019s caller. You can find a more detailed explanation along with some concrete examples in ",(0,a.kt)("a",{target:"_blank",href:n(75580).Z},"these notes"),"."),(0,a.kt)("p",null,"Bugs due to calling convention violations can often be difficult to find manually, so Venus provides a way to automatically report some of these errors at runtime."),(0,a.kt)("p",null,"Take a look at the contents of the ",(0,a.kt)("inlineCode",{parentName:"p"},"cc_test.s")," file, particularly at the ",(0,a.kt)("inlineCode",{parentName:"p"},"main"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"simple_fn"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"naive_pow"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"inc_arr"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"helper_fn")," functions. Now, run Venus locally with the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ java -jar tools/venus.jar -cc lab03/cc_test.s\n\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note:")," The ",(0,a.kt)("inlineCode",{parentName:"p"},"-cc")," flag ",(0,a.kt)("strong",{parentName:"p"},"MUST")," go between ",(0,a.kt)("inlineCode",{parentName:"p"},"tool/venus.jar")," and the file you\u2019re running. If it goes before ",(0,a.kt)("inlineCode",{parentName:"p"},"venus.jar")," it will be treated as an argument to the ",(0,a.kt)("inlineCode",{parentName:"p"},"java")," program; if it goes after the file name it will treated as an argument to the ",(0,a.kt)("inlineCode",{parentName:"p"},"main")," function of your assembly program."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"-cc")," flag enables the calling convention checker, and detects some basic violations. You should see an output similar to the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"[CC Violation]: (PC=0x00000080) Usage of unset register t0! main.S:58 mv a0, t0\n[CC Violation]: (PC=0x0000008C) Setting of a saved register (s0) which has not been saved! main.S:80 li s0, 1\n[CC Violation]: (PC=0x00000094) Setting of a saved register (s0) which has not been saved! main.S:83 mul s0, s0, a0\n[CC Violation]: (PC=0x00000094) Setting of a saved register (s0) which has not been saved! main.S:83 mul s0, s0, a0\n[CC Violation]: (PC=0x00000094) Setting of a saved register (s0) which has not been saved! main.S:83 mul s0, s0, a0\n[CC Violation]: (PC=0x00000094) Setting of a saved register (s0) which has not been saved! main.S:83 mul s0, s0, a0\n[CC Violation]: (PC=0x00000094) Setting of a saved register (s0) which has not been saved! main.S:83 mul s0, s0, a0\n[CC Violation]: (PC=0x00000094) Setting of a saved register (s0) which has not been saved! main.S:83 mul s0, s0, a0\n[CC Violation]: (PC=0x00000094) Setting of a saved register (s0) which has not been saved! main.S:83 mul s0, s0, a0\n[CC Violation]: (PC=0x000000A4) Save register s0 not correctly restored before return! Expected 0x00000A3F, Actual 0x00000080. main.S:90 ret\n[CC Violation]: (PC=0x000000B0) Setting of a saved register (s0) which has not been saved! main.S:106 mv s0, a0 # Copy start of array to saved register\n[CC Violation]: (PC=0x000000B4) Setting of a saved register (s1) which has not been saved! main.S:107 mv s1, a1 # Copy length of array to saved register\n[CC Violation]: (PC=0x000000E4) Setting of a saved register (s0) which has not been saved! main.S:142 addi s0, t1, 1\nVenus ran into a simulator error!\nAttempting to access uninitialized memory between the stack and heap. Attempting to access '4' bytes at address '347579389'.\n\n")),(0,a.kt)("p",null,"Find the source of each of the errors reported by the CC checker and fix it. Even though the output says ",(0,a.kt)("inlineCode",{parentName:"p"},"main.S"),", the line number reported should still correspond to the correct line in ",(0,a.kt)("inlineCode",{parentName:"p"},"cc_test.s"),": this is just an artifact of the way Venus works in order to support combining multiple assembly files together. You can find a list of CC error messages, as well as their meanings, in the ",(0,a.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20230126061759/https://inst.eecs.berkeley.edu/~cs61c/sp21/resources/venus-reference#calling-convention-checker"},"Venus reference"),"."),(0,a.kt)("p",null,"Once you\u2019ve fixed all the violations reported by the CC checker, the code might still fail: this is likely because there\u2019s still some remaining calling convention errors that Venus doesn\u2019t report. Since function calls in assembly language are ultimately just jumps, Venus can\u2019t report these violations without more information, at risk of producing false positives."),(0,a.kt)("p",null,"The fixes for all of these errors (both the ones reported by the CC checker and the ones it can\u2019t find) should be added near the lines marked by the ",(0,a.kt)("inlineCode",{parentName:"p"},"FIXME")," comments in the starter code."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note:")," Venus\u2019s calling convention checker will not report all calling convention bugs; it is intended to be used primarily as a sanity check. Most importantly, it will only look for bugs in functions that are exported with the ",(0,a.kt)("inlineCode",{parentName:"p"},".globl")," directive - the meaning of ",(0,a.kt)("inlineCode",{parentName:"p"},".globl")," is explained in more detail in the ",(0,a.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20230126061759/https://inst.eecs.berkeley.edu/~cs61c/sp21/resources/venus-reference#working-with-multiple-files"},"Venus reference"),"."),(0,a.kt)("h3",{id:"action-item-2"},"Action Item"),(0,a.kt)("p",null,"Resolve all the calling convention errors in ",(0,a.kt)("inlineCode",{parentName:"p"},"cc_test.s"),", and be able to answer the following questions:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"What caused the errors in ",(0,a.kt)("inlineCode",{parentName:"li"},"simple_fn"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"naive_pow"),", and ",(0,a.kt)("inlineCode",{parentName:"li"},"inc_arr")," that were reported by the Venus CC checker?"),(0,a.kt)("li",{parentName:"ul"},"In RISC-V, we call functions by jumping to them and storing the return address in the ",(0,a.kt)("inlineCode",{parentName:"li"},"ra")," register. Does calling convention apply to the jumps to the ",(0,a.kt)("inlineCode",{parentName:"li"},"naive_pow_loop")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"naive_pow_end")," labels?"),(0,a.kt)("li",{parentName:"ul"},"Why do we need to store ",(0,a.kt)("inlineCode",{parentName:"li"},"ra")," in the prologue for ",(0,a.kt)("inlineCode",{parentName:"li"},"inc_arr"),", but not in any other function?"),(0,a.kt)("li",{parentName:"ul"},"Why wasn\u2019t the calling convention error in ",(0,a.kt)("inlineCode",{parentName:"li"},"helper_fn")," reported by the CC checker? (Hint: it\u2019s mentioned above in the exercise instructions.)")),(0,a.kt)("p",null,"Once you have answered these, run Venus with the calling convention checker on ",(0,a.kt)("inlineCode",{parentName:"p"},"factorial.s")," from the last exercise as well. Make sure to fix any bugs you find."),(0,a.kt)("h3",{id:"testing-1"},"Testing"),(0,a.kt)("p",null,"After fixing the errors in ",(0,a.kt)("inlineCode",{parentName:"p"},"cc_test.s"),", run Venus locally with the above command to make sure the behavior of the functions hasn\u2019t changed and that you\u2019ve remedied all calling convention violations."),(0,a.kt)("p",null,"Once you have fixed everything, running the above Venus command should output the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Sanity checks passed! Make sure there are no CC violations.\nFound 0 warnings!\n\n")),(0,a.kt)("h2",{id:"exercise-5-risc-v-function-calling-with-map"},"Exercise 5: RISC-V function calling with ",(0,a.kt)("inlineCode",{parentName:"h2"},"map")),(0,a.kt)("p",null,"This exercise uses the file ",(0,a.kt)("inlineCode",{parentName:"p"},"list_map.s"),"."),(0,a.kt)("p",null,"In this exercise, you will complete an implementation of ",(0,a.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20230126061759/https://en.wikipedia.org/wiki/Map_(higher-order_function)"},(0,a.kt)("inlineCode",{parentName:"a"},"map"))," on linked-lists in RISC-V. Our function will be simplified to mutate the list in-place, rather than creating and returning a new list with the modified values."),(0,a.kt)("p",null,"You will find it helpful to refer to the ",(0,a.kt)("a",{target:"_blank",href:n(56230).Z},"RISC-V green card")," to complete this exercise. If you encounter any instructions or pseudo-instructions you are unfamiliar with, use this as a resource."),(0,a.kt)("p",null,"Our ",(0,a.kt)("inlineCode",{parentName:"p"},"map")," procedure will take two parameters; the first parameter will be the address of the head node of a singly-linked list whose values are 32-bit integers. So, in C, the structure would be defined as:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"struct node {\n    int value;\n    struct node *next;\n};\n\n")),(0,a.kt)("p",null,"Our second parameter will be the ",(0,a.kt)("strong",{parentName:"p"},"address of a function")," that takes one int as an argument and returns an int. We\u2019ll use the ",(0,a.kt)("inlineCode",{parentName:"p"},"jalr")," RISC-V instruction to call this function on the list node values."),(0,a.kt)("p",null,"Our ",(0,a.kt)("inlineCode",{parentName:"p"},"map")," function will recursively go down the list, applying the function to each value of the list and storing the value returned in that corresponding node. In C, the function would be something like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"void map(struct node *head, int (*f)(int))\n{\n    if (!head) { return; }\n    head->value = f(head->value);\n    map(head->next,f);\n}\n\n")),(0,a.kt)("p",null,"If you haven\u2019t seen the ",(0,a.kt)("inlineCode",{parentName:"p"},"int (*f)(int)")," kind of declaration before, don\u2019t worry too much about it. Basically it means that ",(0,a.kt)("inlineCode",{parentName:"p"},"f")," is a pointer to a function, which, in C, can then be used exactly like any other function."),(0,a.kt)("p",null,"There are exactly nine (9) markers (8 in ",(0,a.kt)("inlineCode",{parentName:"p"},"map")," and 1 in ",(0,a.kt)("inlineCode",{parentName:"p"},"main"),") in the provided code where it says ",(0,a.kt)("inlineCode",{parentName:"p"},"YOUR CODE HERE"),"."),(0,a.kt)("h3",{id:"action-item-3"},"Action Item"),(0,a.kt)("p",null,"Complete the implementation of ",(0,a.kt)("inlineCode",{parentName:"p"},"map")," by filling out each of these nine markers with the appropriate code. Furthermore, provide a sample call to ",(0,a.kt)("inlineCode",{parentName:"p"},"map")," with ",(0,a.kt)("inlineCode",{parentName:"p"},"square")," as the function argument. There are comments in the code that explain what should be accomplished at each marker. When you\u2019ve filled in these instructions, running the code should provide you with the following output:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"9 8 7 6 5 4 3 2 1 0\n81 64 49 36 25 16 9 4 1 0\n\n")),(0,a.kt)("p",null,"The first line is the original list, and the second line is the modified list after the map function (in this case square) is applied."),(0,a.kt)("h3",{id:"testing-2"},"Testing"),(0,a.kt)("p",null,"To test this in the Venus web simulator, run ",(0,a.kt)("inlineCode",{parentName:"p"},"list_map.s")," and examine the output. To test this locally, run the following command in your root lab directory (much like the one for ",(0,a.kt)("inlineCode",{parentName:"p"},"factorial.s"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ java -jar tools/venus.jar lab03/list_map.s\n\n")),(0,a.kt)("h2",{id:"transitioning-to-more-complex-risc-v-programs"},"Transitioning to More Complex RISC-V Programs"),(0,a.kt)("p",null,"In the future, we\u2019ll be working with more complex RISC-V programs that require multiple files of assembly code. To prepare for this, we recommend looking over the following sections of the Venus reference:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://web.archive.org/web/20230126061759/https://inst.eecs.berkeley.edu/~cs61c/sp21/resources/venus-reference#writing-larger-risc-v-programs"},"Writing Larger RISC-V Programs")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://web.archive.org/web/20230126061759/https://inst.eecs.berkeley.edu/~cs61c/sp21/resources/venus-reference#the-venus-tab"},"Using the Web Terminal")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://web.archive.org/web/20230126061759/https://inst.eecs.berkeley.edu/~cs61c/sp21/resources/venus-reference#the-venus-tab"},"Passing Command Line Arguments"))),(0,a.kt)("h2",{id:"checkoff"},"Checkoff"),(0,a.kt)("p",null,"Please submit to the Lab Autograder assignment (same as last week!)."),(0,a.kt)("p",null,"Checkoff questions for lab 3:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Make sure you understand and can answer the questions in exercises 1, 2, and 4!")))}p.isMDXComponent=!0},75580:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/files/RISCV_Calling_Convention-fb38c62ecbe1cc07ab5b25522d6192e4.pdf"},56230:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/files/riscvcard-75f9fb3a791fab6eee17d3cf216f77f0.pdf"}}]);