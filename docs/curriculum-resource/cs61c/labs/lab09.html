<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-curriculum-resource/cs61c/labs/lab09" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Lab09 | CS自学社区</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.learncs.site/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.learncs.site/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.learncs.site/docs/curriculum-resource/cs61c/labs/lab09"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab09 | CS自学社区"><meta data-rh="true" name="description" content="Lab 09"><meta data-rh="true" property="og:description" content="Lab 09"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.learncs.site/docs/curriculum-resource/cs61c/labs/lab09"><link data-rh="true" rel="alternate" href="https://www.learncs.site/docs/curriculum-resource/cs61c/labs/lab09" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.learncs.site/docs/curriculum-resource/cs61c/labs/lab09" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CS自学社区 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CS自学社区 Atom Feed">



<link rel="preconnect" href="https://hm.baidu.com">
<script async src="https://hm.baidu.com/hm.js?c106b2729592653e5e0c26db5e5d3142"></script>
<script src="https://sf-cdn.coze.com/obj/unpkg-va/flow-platform/chat-app-sdk/0.1.0-beta.4/libs/oversea/index.js"></script>
<script>document.addEventListener("DOMContentLoaded",(function(){console.log("DOMContentLoaded coze"),new CozeWebSDK.WebChatClient({config:{bot_id:"7380921096788590598"},componentProps:{title:"AI 助教"}})}))</script><link rel="stylesheet" href="/assets/css/styles.0cbaf963.css">
<link rel="preload" href="/assets/js/runtime~main.19163e04.js" as="script">
<link rel="preload" href="/assets/js/main.1bc29555.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="TeachYourselfCS" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="TeachYourselfCS" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TeachYourselfCS</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">自学路线</a><a class="navbar__item navbar__link" href="/blog">博客</a><a class="navbar__item navbar__link" href="/community">社区</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">前言</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/roadmap">路线图</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/课程资源">课程资源</a><button aria-label="Toggle the collapsible sidebar category &#x27;课程资源&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/curriculum-resource/cs50x">cs50x</a><button aria-label="Toggle the collapsible sidebar category &#x27;cs50x&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/curriculum-resource/cs61a">cs61a</a><button aria-label="Toggle the collapsible sidebar category &#x27;cs61a&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/curriculum-resource/cs61b">cs61b</a><button aria-label="Toggle the collapsible sidebar category &#x27;cs61b&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/curriculum-resource/cs61c">cs61c</a><button aria-label="Toggle the collapsible sidebar category &#x27;cs61c&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/syllabus">syllabus-课程大纲</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab00">labs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab00">Lab0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab01">Lab01</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab02">Lab02</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab03">Lab03</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab04">Lab04</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab05">Lab05</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab06">Lab06</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab07">Lab07</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab08">Lab08</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab09">Lab09</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab10">Lab10</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/curriculum-resource/cs61c/labs/lab11">Lab11</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/curriculum-resource/cs61c/projects/proj1">projects</a></div></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/课程资源"><span itemprop="name">课程资源</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/curriculum-resource/cs61c"><span itemprop="name">cs61c</span></a><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">labs</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab09</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 9</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-09">Lab 09<a href="#lab-09" class="hash-link" aria-label="Direct link to Lab 09" title="Direct link to Lab 09">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="objectives">Objectives:<a href="#objectives" class="hash-link" aria-label="Direct link to Objectives:" title="Direct link to Objectives:">​</a></h2><ul><li>TSW learn about and use various SIMD functions to perform data level parallelism</li><li>TSW write code to SIMD-ize certain functions</li><li>TSW learn about loop-unrolling and why it works</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">​</a></h2><p>Pull Lab 09 files from the lab starter repository with</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disclaimer">Disclaimer<a href="#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h2><p><strong>NOTE THAT ALL CODE USING SSE INSTRUCTIONS IS GUARANTEED TO WORK ON THE HIVE MACHINES AND IT MAY NOT WORK ELSEWHERE</strong></p><p>Many newer processors support SSE intrinsics, so it is certainly possible that your machine will be sufficient, but you may not see accurate speedups. Ideally, you should ssh into one of the hive machines to run this lab. Additionally, many of the performance characteristics asked about later on this lab are more likely to show up on the Hive.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exercise-1---familiarize-yourself-with-the-simd-functions">Exercise 1 - Familiarize Yourself with the SIMD Functions<a href="#exercise-1---familiarize-yourself-with-the-simd-functions" class="hash-link" aria-label="Direct link to Exercise 1 - Familiarize Yourself with the SIMD Functions" title="Direct link to Exercise 1 - Familiarize Yourself with the SIMD Functions">​</a></h2><p>Given the large number of available SIMD intrinsics we want you to learn how to find the ones that you’ll need in your application.</p><p>For this mini-exercise, we ask you to look at the <a href="https://web.archive.org/web/20230923035841/https://software.intel.com/sites/landingpage/IntrinsicsGuide/" target="_blank" rel="noopener noreferrer">Intel Intrinsics Guide</a>. Open this page and once there, click the checkboxes for everything that begins with “SSE”.</p><p>Look through the possible instructions and syntax structures, then try to find the 128-bit intrinsics for the following operations:</p><ul><li>Four floating point divisions in single precision (i.e. float)</li><li>Sixteen max operations over signed 8-bit integers (i.e. char)</li><li>Arithmetic shift right of eight signed 16-bit integers (i.e. short)</li></ul><p>Hint: Things that say “epi” or “pi” deal with integers, and those that say “<strong>ps</strong>” or “<strong>pd</strong>” deal with <strong>s</strong> ingle <strong>p</strong> recision and <strong>d</strong> ouble <strong>p</strong> recision floats.</p><p>You can visualize how the vectors and the different functions work together by inputting your code into the code environment at this <a href="https://web.archive.org/web/20230923035841/https://piotte13.github.io/SIMD-Visualiser/#/" target="_blank" rel="noopener noreferrer">link</a>! Another interesting tool that might help you understand the behavior of SIMD instructions is the <a href="https://web.archive.org/web/20230923035841/https://godbolt.org/z/J7HXBk" target="_blank" rel="noopener noreferrer">Compiler Explorer</a> project. It can also provide a lot of insights when you need to optimize any code in the future.</p><p>General advice on working with SIMD instructions:</p><ul><li>Be ware of memory alignment. For example, <code>_m256d _mm256_load_pd (double const * mem_addr)</code> would not work with unaligned data – you would need <code>_m256d _mm256_loadu_pd</code>. Meanwhile, it is almost always desireable to keep your data aligned (can be achieved using special memory allocation APIs). In fact, when the data is aligned, aligned load/store will give identical performance to an aligned store. Aligned loads can be folded into other operations as a memory operand which reduces code size and throughput slightly. Modern CPUs have very good support for unaligned loads, but there’s still a significant performance hit when a load crosses a cache-line boundary.</li><li>Recall various CPU pipeline hazards you have learned earlier this semester. Data hazards can drastically hurt performance. That being said, you may want to check data dependencies in adjacent SIMD operations if not getting the desired performance.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exercise-2---writing-simd-code">Exercise 2 - Writing SIMD Code<a href="#exercise-2---writing-simd-code" class="hash-link" aria-label="Direct link to Exercise 2 - Writing SIMD Code" title="Direct link to Exercise 2 - Writing SIMD Code">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-mistakes">Common Mistakes<a href="#common-mistakes" class="hash-link" aria-label="Direct link to Common Mistakes" title="Direct link to Common Mistakes">​</a></h3><p>The following are bugs that the staff have noticed which were preventing students from passing the tests (bold text is what you should not do):</p><ul><li><strong>Trying to store your sum vector into a <code>long long int</code> array</strong>. Use an int array. <strong>Side note: why??</strong> The return value of this function is indeed a <code>long long int</code>, but that’s because an <code>int</code> isn’t big enough to hold the sum of all the values across all iterations of the outer loop. However, it is big enough to hold the sum of all the values across a single iteration of the outer loop. This means you’ll want to store your sum vector into an <code>int</code> array after every iteration of the outer loop and add the total sum to the final result <code>result</code>.</li><li><strong>Re-initializing your sum vector</strong>. Make sure when you add to your running sum vector; <strong>you are not</strong> declaring a new sum vector!!</li><li><strong>Forgetting the CONDITIONAL in the tail case.</strong> What condition have we been checking before adding something to the sum?</li><li><strong>Adding to an UNINITIALIZED array.</strong> If you add stuff to your result array without initializing it, you are adding stuff to garbage, which makes the array still garbage! Using <code>storeu</code> before adding stuff is okay though.</li></ul><p>We’ve got one file <code>simd.c</code> that has some code to sum the elements of a really big array. It’s a minor detail that it randomly does this <code>1 &lt;&lt; 16</code> times… but you don’t need to worry about that. We also pince the execution of the code between two timestamps (that’s what the <code>clock()</code> function does) to measure how fast it runs! The file <code>test_simd.c</code> is the one which will have a <code>main</code> function to run the <code>sum</code> functions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task">Task<a href="#task" class="hash-link" aria-label="Direct link to Task" title="Direct link to Task">​</a></h3><p>We ask you to vectorize/SIMDize the code in <code>simd.c</code> to speed up the naive implementation of <code>sum()</code>.</p><p>You only need to vectorize the inner loop with SIMD! You will also need to use the following intrinsics:</p><ul><li><code>__m128i _mm_setzero_si128()</code> - returns a 128-bit zero vector</li><li><code>__m128i _mm_loadu_si128(__m128i *p)</code> - returns 128-bit vector stored at pointer p</li><li><code>__m128i _mm_add_epi32(__m128i a, __m128i b)</code> - returns vector (a<!-- -->_<!-- -->0 + b<!-- -->_<!-- -->0, a<!-- -->_<!-- -->1 + b<!-- -->_<!-- -->1, a<!-- -->_<!-- -->2 + b<!-- -->_<!-- -->2, a<!-- -->_<!-- -->3 + b<!-- -->_<!-- -->3)</li><li><code>void _mm_storeu_si128(__m128i *p, __m128i a)</code> - stores 128-bit vector a into pointer p</li><li><code>__m128i _mm_cmpgt_epi32(__m128i a, __m128i b)</code> - returns the vector (a<!-- -->_<!-- -->i &gt; b<!-- -->_<!-- -->i ? <code>0xffffffff : 0x0</code> for <code>i</code> from 0 to 3). AKA a 32-bit all-1s mask if a<!-- -->_<!-- -->i &gt; b<!-- -->_<!-- -->i and a 32-bit all-0s mask otherwise</li><li><code>__m128i _mm_and_si128(__m128i a, __m128i b)</code> - returns vector (a<!-- -->_<!-- -->0 &amp; b<!-- -->_<!-- -->0, a<!-- -->_<!-- -->1 &amp; b<!-- -->_<!-- -->1, a<!-- -->_<!-- -->2 &amp; b<!-- -->_<!-- -->2, a<!-- -->_<!-- -->3 &amp; b<!-- -->_<!-- -->3), where &amp; represents the bit-wise and operator</li></ul><p>Start with the code in <code>sum()</code> and use SSE intrinsics to implement the <code>sum_simd()</code> function.</p><p>How do I do this?</p><p>Recall that the SSE intrinsics are basically functions which perform operations on multiple pieces of data in a vector in parallel. This turns out to be faster than running through a for loop and applying the operation once for each element in the vector.</p><p>In our sum function, we’ve got a basic structure of iterating through an array. On every iteration, we add an array element to a running sum. To vectorize, you should add a few array elements to a sum vector in parallel and then consolidate the individual values of the sum vector into our desired sum at the end.</p><ul><li>Hint 1: <code>__m128i</code> is the data type for Intel’s special 128-bit vector. We’ll be using them to encode 4 (four) 32-bit ints.</li><li>Hint 2: We’ve left you a vector called <code>_127</code> which contains four copies of the number 127. You should use this to compare with some stuff when you implement the condition within the sum loop.</li><li>Hint 3: DON’T use the store function (<code>_mm_storeu_si128</code>) until after completing the inner loop! It turns out that storing is very costly and performing a store in every iteration will actually cause your code to slow down. However, if you wait until after the outer loop completes you may have overflow issues.</li><li>Hint 4: It’s bad practice to index into the <code>__m128i</code> vector like they are arrays. You should store them into arrays first with the <code>storeu</code> function, and then access the integers elementwise by indexing into the array.</li><li>Hint 5: READ the function declarations in the above table carefully! You’ll notice that the loadu and storeu take <code>__m128i*</code> type arguments. You can just cast an int array to a <code>__m128i</code> pointer. Alternatively, you could skip the typecast at the cost of a bunch of compiler warnings.</li></ul><p>To compile and run your code, run the following commands:</p><p>Sanity check: The naive version runs at about 7 seconds on the hive machines, and your SIMDized version should run in about 1-2 seconds.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exercise-3---loop-unrolling">Exercise 3 - Loop Unrolling<a href="#exercise-3---loop-unrolling" class="hash-link" aria-label="Direct link to Exercise 3 - Loop Unrolling" title="Direct link to Exercise 3 - Loop Unrolling">​</a></h2><p><strong>Concept Time!</strong> Another tactic used to increase performance is to unroll our for loops! By performing more operations per iteration of the for loop, we have to loop less and not have to waste as many cycles (think about why we would have to waste some cycles?). Theoretically, code would be faster if we didn’t create loops and just copy pasted the loop <code>n</code> times, but that’s not a very pretty function.</p><p>For example, consider this very simple example that adds together the first n elements of an array <code>arr</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int total = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (int i = 0; i &lt; n; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total += arr[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The corresponding assembly code might look something like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        add t0, x0, x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add t1, x0, x0 // Initialize loop counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop:   beq t0, a1, end // Assume register a1 contains the size n of the array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        slli t2, t1, 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add t2, t1, a0 // Assume register a0 contains a pointer to the beginning of the array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lw t3, 0(t2) // Load arr[i] into t3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add t0, t3, t0 // total += arr[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addi t1, t1, 1 // Increment the loop counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jal x0, loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end:    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we unroll the loop 4 times, this would be our equivalent code, with a tail case for the situations where n is not a multiple of 4:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int total = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (int i = 0; i &lt; n / 4 * 4; i+=4) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total += arr[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total += arr[i + 1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total += arr[i + 2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total += arr[i + 3];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (i = n / 4 * 4; i &lt; n; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total += arr[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For the unrolled code, the corresponding assembly code might look something like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      add t0, x0, x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t1, a1, x0 // Assume register a1 contains the size n of the array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      srli t1, t1, 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      slli t1, t1, 2 // Find largest of multiple 4 &lt;= n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t2, x0, x0 // Initialize loop counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop: beq t2, t1, tail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      slli t3, t2, 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t3, t3, a0 // Assume register a0 contains a pointer to the beginning of the array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lw t4, 0(t3) // Load arr[i] into t3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t0, t4, t0 // total += arr[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lw t4, 4(t3) // Load arr[i + 1] into t3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t0, t4, t0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lw t4, 8(t3), t0 // Load arr[i + 2] into t3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t0, t4, t0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lw t4, 12(t3), // Load arr[i + 3] into t3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t0, t4, t0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      addi t2, t2, 4 // Increment the loop counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      jal x0, loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail: beq t2, a1, end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      slli t3, t2, 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lw t4, 0(t3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      add t0, t4, t0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      addi t2, t2, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end: ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To obtain even more performance improvement, carefully unroll the SIMD vector sum code that you created in the previous exercise to create <code>sum_simd_unrolled()</code>. This should get you a little more increase in performance from <code>sum_simd</code> (a few fractions of a second). As an example of loop unrolling, consider the supplied function <code>sum_unrolled()</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-1">Task<a href="#task-1" class="hash-link" aria-label="Direct link to Task" title="Direct link to Task">​</a></h3><p>Within <code>simd.c</code>, copy your <code>sum_simd()</code> code into <code>sum_simd_unrolled()</code> and unroll it 4 (four) times. Don’t forget about your tail case!</p><p>To compile and run your code, run the following commands:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="checkoff">Checkoff<a href="#checkoff" class="hash-link" aria-label="Direct link to Checkoff" title="Direct link to Checkoff">​</a></h2><p>Please submit to the <strong>Lab Autorgrader</strong> assignment.</p><p>In your check-in, feel free to explain your implementation of <code>sum_simd()</code> and <code>sum_simd_unrolled()</code>. How much faster did the SIMD code run over the naive implementation? How much of a performance boost did unrolling provide (and why did it increase performance)?</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/curriculum-resource/cs61c/labs/lab08"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lab08</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/curriculum-resource/cs61c/labs/lab10"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lab10</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#lab-09" class="table-of-contents__link toc-highlight">Lab 09</a></li><li><a href="#objectives" class="table-of-contents__link toc-highlight">Objectives:</a></li><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup</a></li><li><a href="#disclaimer" class="table-of-contents__link toc-highlight">Disclaimer</a></li><li><a href="#exercise-1---familiarize-yourself-with-the-simd-functions" class="table-of-contents__link toc-highlight">Exercise 1 - Familiarize Yourself with the SIMD Functions</a></li><li><a href="#exercise-2---writing-simd-code" class="table-of-contents__link toc-highlight">Exercise 2 - Writing SIMD Code</a><ul><li><a href="#common-mistakes" class="table-of-contents__link toc-highlight">Common Mistakes</a></li><li><a href="#task" class="table-of-contents__link toc-highlight">Task</a></li></ul></li><li><a href="#exercise-3---loop-unrolling" class="table-of-contents__link toc-highlight">Exercise 3 - Loop Unrolling</a><ul><li><a href="#task-1" class="table-of-contents__link toc-highlight">Task</a></li></ul></li><li><a href="#checkoff" class="table-of-contents__link toc-highlight">Checkoff</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">CS学习社区</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">路线图</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.19163e04.js"></script>
<script src="/assets/js/main.1bc29555.js"></script>
</body>
</html>